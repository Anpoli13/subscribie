{% extends "admin/layout.html" %}                                              
{% block title %} Upcoming Payments{% endblock %}                                
                                                                                 
{% block hero %}                                                                 
                                                                                 
<h1 class="title is-1 has-text-white has-text-centered is-size-3-mobile">
    Upcoming Payments
</h1>                                                                        
                                                                                 
{% endblock hero %} 
                                                                                 
{% block body %}
<style>
td b {
    line-height: 36px;
}
</style>

<div style="padding: 1rem 1.5rem 0 1.5rem;">                                     
  <div class="container">                                                        
    <nav class="breadcrumb" aria-label="breadcrumbs">                            
      <ul>                                                                       
        <li><a href="/">Shop</a></li>                                            
        <li><a href="{{ url_for('admin.dashboard') }}">Dashboard</a></li>   
        <li class="is-active"><a href="#" aria-current="page">
            Upcoming Payments</a>
        </li>                                                                    
      </ul>                                                                      
    </nav>
  </div>                                                                         
</div>

<div class="section">
  <div class="container">

    <a href="{{ url_for('admin.upcoming_payments', previous=previous_page_cursor) }}"
      class="pagination-previous">Previous</a>
    <a href="{{ url_for('admin.upcoming_payments', next=next_page_cursor) }}"
      class="pagination-next">Next</a>

    <table class="table is-hoverable is-fullwidth">

      <thead>
        <tr>
          <th>Fulfillment State</th>
          <th>Date</th>
          <th>GoCardless ID</th>
          <th>Status</th>
          <th>Amount</th>
          <th>Name</th>
          <th>Contacts</th>
          <th>Address</th>
          <th>Subscription</th>
        </tr>
      </thead>

      <tbody>
      {% if payments|length == 0 %}
        <tr>
          <td colspan="8">
             No upcoming payments yet. You can do it!
          </td>
        </td>
      {% endif %}

      {% for payment in payments %}
        <tr>
          <td>
            <form action="{{ url_for('admin.update_payment_fulfillment', gocardless_payment_id=payment.id) }}" method="GET">
              <select name="state">
                {% set fulfillment_state = get_transaction_fulfillment_state(payment.id) %}
                <option value="">-</option>
                <option value="complete"
                  {% if fulfillment_state == "complete" %}
                  selected
                  {% endif %}>
                  Complete
                </option>
              </select>
              <input type="hidden" name="gocardless_id" value="{{ payment.id }}" />
              <input type="submit" value="Update" />
            </form>
          </td>
          <td>{{ datetime.strptime(payment.charge_date, '%Y-%m-%d').strftime("%d/%m/%Y") }}</td>
          <td>{{ payment.id }}</td>
          <td>{{ payment.status }}</td>
          <td>{{ payment.amount|default(0)|currencyFormat}}</td>
          {% if get_subscription_from_gocardless_subscription_id(payment.links['subscription']) != none  %}
          {% set subscription = get_subscription_from_gocardless_subscription_id(payment.links['subscription']) %}
          <td>{{ subscription.person.given_name }} {{ subscription.person.family_name }}</td>
          <td>
            <strong>Email: </strong><a href="mailto:{{ subscription.person.email }}">{{ subscription.person.email }}</a><br>
            <strong>Phone: </strong><a href="tel:{{ subscription.person.mobile}}">{{ subscription.person.mobile}}</a><br>
          </td>
          <td><address>
              {{ subscription.person.address_line1 }}<br />
              {{ subscription.person.city }}
              {{ subscription.person.postal_code }}
          </address></td>
          <td>
            <div class="content">
              <ul class="is-unstyled-li">
                <li>
                  <div class="card">
                    <ul class="is-unstyled-li">
                      <li><strong>Title: </strong>{{ subscription.item.title }}</li>
                      <li><strong>Description:</strong>
                        <ul>
                          {% for selling_point in subscription.item.selling_points %}
                            <li>{{ selling_point.point }}</li>
                          {% endfor %}
                        </ul>
                      </li>
                      <li><strong>ID: </strong>{{ payment.links['subscription'] }}</li>
                      <li><strong>Date started: </strong>{{ subscription.created_at.strftime('%d/%m/%Y') }}</li>
                    </ul>
                  </div>
                </li>  
              </ul>
            </div>
          </td>
          {% else %}
          <td colspan="4"></td>
          {% endif %}
        </tr>
      {% endfor %}
      </tbody>
      
    </table>
  </div><!-- end .container -->
</div><!-- end .section -->

{% endblock body %} 

